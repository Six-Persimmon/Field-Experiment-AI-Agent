<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Survey Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .view { display: none; }
    .view.active { display: block; }
    .log-entry { font-family: 'Courier New', Courier, monospace; font-size: .875rem; padding: .25rem .5rem; border-radius: .25rem; }
    .log-info { background-color: #e0f2fe; color: #0c4a6e; }
    .log-success { background-color: #dcfce7; color: #166534; }
    .log-warn { background-color: #fef9c3; color: #854d0e; }
    .log-error { background-color: #fee2e2; color: #991b1b; }
    .log-api { background-color: #e5e7eb; color: #1f2937; }
    .modal-backdrop { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.5); z-index:40; display:none; }
    .modal { position: fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:50; display:none; }
    .modal-backdrop.active, .modal.active { display:block; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-900">Interactive Survey Tool</h1>
      <p class="text-lg text-gray-600 mt-2">A complete survey processing pipeline.</p>
    </header>

    <!-- API Key View -->
    <div id="apiKeyView" class="view active">
      <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-2xl font-semibold mb-6 text-center"><i class="fas fa-key mr-2"></i>API Configuration</h2>
        <p class="text-center text-gray-500 mb-6">Your API keys will be sent to your backend for secure use. They are not stored in the browser.</p>
        <div class="space-y-6">
          <div>
            <h3 class="text-lg font-medium text-gray-700 border-b pb-2 mb-4">Qualtrics</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="qualtricsApiToken" class="block text-sm font-medium text-gray-600">API Token</label>
                <input type="password" id="qualtricsApiToken" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="your_token_here">
              </div>
              <div>
                <label for="qualtricsDataCenter" class="block text-sm font-medium text-gray-600">Data Center ID</label>
                <input type="text" id="qualtricsDataCenter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="your_datacenter_id">
              </div>
            </div>
          </div>
          <div>
            <h3 class="text-lg font-medium text-gray-700 border-b pb-2 mb-4">AWS (MTurk)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="awsAccessKeyId" class="block text-sm font-medium text-gray-600">Access Key ID</label>
                <input type="password" id="awsAccessKeyId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="your_access_key">
              </div>
              <div>
                <label for="awsSecretAccessKey" class="block text-sm font-medium text-gray-600">Secret Access Key</label>
                <input type="password" id="awsSecretAccessKey" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="your_secret_key">
              </div>
            </div>
            <div class="mt-4">
              <label for="mturkSandbox" class="block text-sm font-medium text-gray-600 mb-2">MTurk Mode</label>
              <select id="mturkSandbox" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <option value="True" selected>Sandbox (Simulation)</option>
                <option value="False">Production (Real Experiment)</option>
              </select>
            </div>
          </div>
          <div>
            <h3 class="text-lg font-medium text-gray-700 border-b pb-2 mb-4">LLM Models</h3>
            <div class="space-y-4">
              <div>
                <label for="openaiApiKey" class="block text-sm font-medium text-gray-600">OpenAI API Key</label>
                <input type="password" id="openaiApiKey" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="your_openai_key">
              </div>
              <div>
                <label for="anthropicApiKey" class="block text-sm font-medium text-gray-600">Anthropic API Key</label>
                <input type="password" id="anthropicApiKey" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="your_claude_key">
              </div>
            </div>
          </div>
        </div>
        <div class="mt-8 text-center">
          <button id="saveApiKeys" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
            <i class="fas fa-save mr-2"></i>Save and Continue
          </button>
        </div>
      </div>
    </div>

    <!-- Main Menu View -->
    <div id="mainMenuView" class="view">
      <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
        <button data-target="createSurveyView" class="main-menu-btn bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 text-left">
          <i class="fas fa-plus-circle text-3xl text-blue-500 mb-4"></i>
          <h3 class="text-xl font-semibold text-gray-800">Create & Enhance Survey</h3>
          <p class="text-gray-500 mt-2">Start with raw text, enhance with AI feedback, and prepare for deployment.</p>
        </button>
        <button data-target="collectHumanDataView" class="main-menu-btn bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 text-left">
          <i class="fas fa-users text-3xl text-green-500 mb-4"></i>
          <h3 class="text-xl font-semibold text-gray-800">Collect Human Data</h3>
          <p class="text-gray-500 mt-2">Fetch results from a deployed Qualtrics survey and MTurk HIT.</p>
        </button>
        <button data-target="collectSimulatedDataView" class="main-menu-btn bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 text-left">
          <i class="fas fa-robot text-3xl text-purple-500 mb-4"></i>
          <h3 class="text-xl font-semibold text-gray-800">Collect Simulated Data</h3>
          <p class="text-gray-500 mt-2">Generate simulated survey responses using LLMs and debias the results.</p>
        </button>
        <button data-target="generatePaperView" class="main-menu-btn bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 text-left">
          <i class="fas fa-file-alt text-3xl text-red-500 mb-4"></i>
          <h3 class="text-xl font-semibold text-gray-800">Generate Research Paper</h3>
          <p class="text-gray-500 mt-2">Use CSV data to automatically generate a draft research paper.</p>
        </button>
      </div>
    </div>

    <!-- Create & Enhance Survey View -->
    <div id="createSurveyView" class="view">
      <button class="back-to-menu-btn mb-6 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300"><i class="fas fa-arrow-left mr-2"></i>Back to Menu</button>
      <div class="flex gap-6">
        <div class="w-1/2">
          <div class="bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4">1. Input Survey Text</h2>
            <p class="text-gray-500 mb-4">Paste your survey text below. Must include 'Topic:' and 'Questions:' lines.</p>
            <textarea id="surveyTextInput" class="w-full h-48 p-3 border border-gray-300 rounded-md" placeholder="Topic: …&#10;Questions: …"></textarea>
            <button id="processSurveyBtn" class="mt-4 w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700">Process Survey</button>
            <div id="enhancement-section" class="mt-8 hidden">
              <div class="mt-6 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <button id="reviewBtn" class="bg-gray-200 p-3 rounded-lg hover:bg-gray-300"><i class="fas fa-eye mr-2"></i>Review</button>
                <button id="aiEnhanceBtn" class="bg-purple-200 p-3 rounded-lg hover:bg-purple-300"><i class="fas fa-magic mr-2"></i>AI Enhance</button>
                <button id="manualEditBtn" class="bg-yellow-200 p-3 rounded-lg hover:bg-yellow-300"><i class="fas fa-edit mr-2"></i>Manual Edit</button>
                <button id="saveSurveyBtn" class="bg-green-200 p-3 rounded-lg hover:bg-green-300"><i class="fas fa-save mr-2"></i>Save</button>
                <button id="deployBtn" class="bg-red-200 p-3 rounded-lg hover:bg-red-300"><i class="fas fa-rocket mr-2"></i>Deploy</button>
              </div>
            </div>
          </div>
        </div>
        <div class="w-1/2 bg-white p-8 rounded-xl shadow-lg">
          <h2 id="sidebarTitle" class="text-2xl font-semibold mb-4">Enhanced Survey</h2>
          <div id="enhancedSurveySidebar" class="overflow-y-auto" style="max-height:500px;"></div>
        </div>
      </div>
    </div>

    <!-- Collect Human Data View -->
    <div id="collectHumanDataView" class="view">
      <button class="back-to-menu-btn mb-6 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300"><i class="fas fa-arrow-left mr-2"></i>Back to Menu</button>
      <div class="bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-2xl font-semibold mb-4">Collect Human Data</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <input id="collectSurveyId" type="text" class="p-3 border rounded-md" placeholder="Qualtrics Survey ID">
          <input id="collectHitId" type="text" class="p-3 border rounded-md" placeholder="MTurk HIT ID (optional)">
        </div>
        <button id="fetchResultsBtn" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700">Fetch Results</button>
        <div id="humanDataResults" class="mt-6 hidden">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-xl font-semibold">Fetched Results</h3>
            <button id="downloadCsvBtn" class="hidden bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700"><i class="fas fa-download mr-2"></i>Download CSV</button>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white border">
              <thead id="humanDataTableHead"></thead>
              <tbody id="humanDataTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Collect Simulated Data View -->
  <div id="collectSimulatedDataView" class="view">
    <button class="back-to-menu-btn mb-6 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">
      ← Back to Menu
    </button>
    <div class="flex gap-6">
      <div class="w-1/2">
        <div class="bg-white p-8 rounded-xl shadow-lg">
          <h2 class="text-2xl font-semibold mb-4">1. Configure Simulation</h2>
          <p class="text-gray-500 mb-4">Provide the content for the simulation files below.</p>
          <div class="space-y-6">
            <div>
              <h4 class="text-lg font-medium mb-2">Survey Response Template</h4>
              <textarea id="simTemplate"
                        class="w-full h-24 p-2 border rounded-md text-gray-500"
                        oninput="this.classList.remove('text-gray-500')">You are a $age-year-old $gender identifying as $race. Please answer the following survey. Please answer the questions by returning ONLY json style answers.</textarea>
            </div>
            <div>
              <h4 class="text-lg font-medium mb-2">Survey JSON Context</h4>
              <textarea id="simSurveyContext"
                        class="w-full h-24 p-2 border rounded-md text-gray-500"
                        oninput="this.classList.remove('text-gray-500')">{"theme":"The Theory of Planned Behavior Survey","purpose":"To assess consumer intentions and beliefs regarding the purchase of organic food.","questions":[{"question_id":"q1","question_text":"I intend to purchase organic food in the next month.","input_type":"multiple_choice","input_config":{"options":["1","2","3","4","5","6","7"]}},{"question_id":"q2","question_text":"Buying organic food is beneficial to my health.","input_type":"multiple_choice","input_config":{"options":["1","2","3","4","5","6","7"]}},{"question_id":"q3","question_text":"I feel confident in my ability to purchase organic food if I want to.","input_type":"multiple_choice","input_config":{"options":["1","2","3","4","5","6","7"]}},{"question_id":"q4","question_text":"How do I think of the organic food?","input_type":"multiple_choice","input_config":{"options":["1","2","3","4","5","6","7"]}},{"question_id":"q5","question_text":"The decision to buy organic food is entirely up to me.","input_type":"multiple_choice","input_config":{"options":["1","2","3","4","5","6","7"]}},{"question_id":"q6","question_text":"What barriers, if any, prevent you from buying organic food?","input_type":"multiple_choice","input_config":{"options":["1","2","3","4","5","6","7"]}},{"question_id":"q7","question_text":"How do elders think of organic food?","input_type":"multiple_choice","input_config":{"options":["1","2","3","4","5","6","7"]}}]}</textarea>
            </div>
            <div>
              <h4 class="text-lg font-medium mb-2">Participant Pool CSV</h4>
              <textarea id="simParticipants"
                        class="w-full h-24 p-2 border rounded-md text-gray-500"
                        oninput="this.classList.remove('text-gray-500')">ParticipantID,Race,Gender,Age
  b7163744-b2b5-4a45-b333-88c6cd63146c,White,Male,24
  ee64c9a6-f560-41f8-b823-275cf3131668,Asian,Female,53
  c4c897b3-7658-4103-b88b-34425ccb8521,Asian,Female,28
  21b3f469-22a2-445e-bdb6-fc576f3e9232,Asian,Male,31
  02ab1090-e43e-4502-b6f0-4c47bab2a13e,Indigenous,Male,42</textarea>
            </div>
          </div>
          <button id="runSimulationBtn"
                  class="mt-4 w-full bg-purple-600 text-white font-semibold py-3 rounded-lg hover:bg-purple-700">
            Run Simulation
          </button>
        </div>
      </div>

      <div class="w-1/2 flex flex-col gap-6">
        <div id="enhancedSidebarWrapper" class="bg-white p-8 rounded-xl shadow-lg">
          <h2 class="text-2xl font-semibold mb-4">Enhanced Survey</h2>
          <div id="simSidebarContent"></div>
        </div>

        <div id="simSidebarWrapper" class="bg-white p-8 rounded-xl shadow-lg hidden">
          <h2 id="simSidebarTitle" class="text-2xl font-semibold mb-4">Simulated Responses</h2>

          <div id="simulatedDataResults" class="mt-6 hidden">
            <div class="flex justify-between items-center mb-2">
              <h3 class="text-xl font-semibold">Initial Simulated Responses</h3>
              <button id="downloadSimulatedBtn"
                      class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">
                <i class="fas fa-download mr-2"></i>Download Raw CSV
              </button>
            </div>
            <pre class="bg-gray-900 text-white p-4 rounded-md overflow-x-auto"
                style="max-height:400px;overflow-y:auto;">
  <code id="simulatedJsonOutput"></code>
            </pre>
          </div>

          <div id="debiasPrompt" class="mt-6 hidden text-center">
            <h3 class="text-xl font-semibold mb-4">Debias Responses?</h3>
            <p class="text-gray-600 mb-4">Run debiasing pipeline on these simulated responses?</p>
            <div class="flex justify-center space-x-4">
              <button id="runDebiasBtn"
                      class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">
                Yes, Debias
              </button>
              <button id="skipDebiasBtn"
                      class="bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-600">
                No, Thanks
              </button>
            </div>
          </div>

          <div id="debiasedDataResults" class="mt-6 hidden">
            <div class="bg-white p-4 rounded-lg shadow mb-4">
              <h3 class="text-xl font-semibold mb-2">Debiased Responses</h3>
              <pre class="bg-gray-900 text-white p-4 rounded-md overflow-x-auto"
                  style="max-height:300px;overflow-y:auto;">
  <code id="debiasedJsonOutput"></code>
              </pre>
              <div class="flex justify-end mt-2">
                <button id="downloadDebiasedBtn"
                        class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">
                  <i class="fas fa-download mr-2"></i>Download Debiased CSV
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

    <!-- Generate Research Paper View -->
    <div id="generatePaperView" class="view">
      <button class="back-to-menu-btn mb-6 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300"><i class="fas fa-arrow-left mr-2"></i>Back to Menu</button>
      <div class="bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-2xl font-semibold mb-4">Generate Research Paper</h2>
        <div class="space-y-4">
          <textarea id="paperCsvData" class="w-full h-48 p-2 border rounded-md" placeholder="Paste your CSV data here..."></textarea>
          <textarea id="paperHypothesis" class="w-full h-24 p-2 border rounded-md" placeholder="Enter your research hypothesis here (optional)..."></textarea>
        </div>
        <button id="generatePaperBtn" class="mt-4 w-full bg-red-600 text-white font-semibold py-3 rounded-lg hover:bg-red-700">Generate Paper</button>
        <div id="paperOutput" class="mt-6 hidden">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-xl font-semibold">Generated Research Paper</h3>
            <button id="downloadPdfBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700"><i class="fas fa-download mr-2"></i>Download PDF</button>
          </div>
          <div class="prose max-w-none p-4 border rounded-md bg-gray-50" id="paperMarkdownOutput"></div>
        </div>
      </div>
    </div>

    <!-- System Log -->
    <div class="mt-12">
      <h2 class="text-2xl font-semibold text-center mb-4">System Log</h2>
      <div id="systemLog" class="bg-white p-4 rounded-lg shadow-md h-64 overflow-y-auto space-y-2">
        <p class="log-entry log-info">System initialized. Please provide API keys to begin.</p>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="modalBackdrop" class="modal-backdrop"></div>
  <div id="aiEnhanceModal" class="modal bg-white p-8 rounded-xl shadow-2xl w-11/12 md:w-1/2 lg:w-1/3">
    <h3 class="text-xl font-semibold mb-4">AI Enhancement Feedback</h3>
    <p class="text-gray-500 mb-4">Provide feedback for the AI to improve the survey.</p>
    <textarea id="aiFeedbackText" class="w-full h-32 p-2 border rounded-md" placeholder="e.g., 'Make the questions more neutral.'"></textarea>
    <div class="mt-6 flex justify-end space-x-3">
      <button id="cancelAiEnhance" class="bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
      <button id="submitAiEnhance" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Submit Feedback</button>
    </div>
  </div>
  <div id="manualEditModal" class="modal bg-white p-8 rounded-xl shadow-2xl w-11/12 md:w-2/3">
    <h3 class="text-xl font-semibold mb-4">Manual JSON Editor</h3>
    <textarea id="manualJsonEditor" class="w-full h-96 p-2 border rounded-md font-mono text-sm"></textarea>
    <div class="mt-6 flex justify-end space-x-3">
      <button id="cancelManualEdit" class="bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
      <button id="saveManualEdit" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600">Save Changes</button>
    </div>
  </div>
  <div id="deployModal" class="modal bg-white p-8 rounded-xl shadow-2xl w-11/12 md:w-1/2">
    <h3 class="text-xl font-semibold mb-4">Deploy Survey</h3>
    <p class="text-gray-500 mb-4">Configure deployment options for Qualtrics and MTurk.</p>
    <div class="space-y-4">
      <div>
        <input id="useMturk" type="checkbox" class="mr-2"><label for="useMturk">Create an MTurk HIT?</label>
      </div>
      <div id="mturkConfig" class="hidden space-y-2 pl-6 border-l-2 border-gray-200">
        <label class="block text-sm font-medium text-gray-600">Reward</label>
        <input id="mturkReward" type="text" class="w-full p-2 border rounded-md" placeholder="e.g., 0.75">
        <label class="block text-sm font-medium text-gray-600">Max Assignments</label>
        <input id="mturkMaxAssignments" type="number" class="w-full p-2 border rounded-md" placeholder="e.g., 100">
      </div>
    </div>
    <div class="mt-6 flex justify-end space-x-3">
      <button id="cancelDeploy" class="bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
      <button id="confirmDeploy" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Deploy Now</button>
    </div>
  </div>

  <script>
    const appState = { apiKeys:{}, enhancedSurvey:null, humanData:[], simulatedData:null, debiasedData:null, generatedPaper:null };

    const logger = {
      log:(m,t='info')=>{const l=document.getElementById('systemLog'),e=document.createElement('p');e.textContent=`[${new Date().toLocaleTimeString()}] ${m}`;e.className=`log-entry log-${t}`;l.appendChild(e);l.scrollTop=l.scrollHeight;},
      info:m=>logger.log(m,'info'), success:m=>logger.log(m,'success'), warn:m=>logger.log(m,'warn'),
      error:m=>logger.log(m,'error'), api:m=>logger.log(m,'api'),
    };

    function showView(id){
      document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if(id==='collectSimulatedDataView'&&appState.enhancedSurvey){
        document.getElementById('simSidebarTitle').textContent='Enhanced Survey';
        renderSurveySummary(appState.enhancedSurvey,'simSidebarContent');
      }
    }
    function showModal(id){document.getElementById('modalBackdrop').classList.add('active');document.getElementById(id).classList.add('active');}
    function hideModals(){document.querySelectorAll('.modal, .modal-backdrop').forEach(el=>el.classList.remove('active'));}

    function renderSurveySummary(s, sid){
      const c=document.getElementById(sid);
      if(!s||!s.revised_survey){c.innerHTML='<p class="text-red-500">Error: Invalid survey structure.</p>';return;}
      const r=s.revised_survey;
      let h=`<h3 class="text-lg font-semibold">${r.theme||'N/A'}</h3><p class="text-sm text-gray-600 mb-4">${r.purpose||'N/A'}</p><div class="space-y-3">`;
      r.questions.forEach(q=>{h+=`<div class="p-2 border-l-4 border-blue-200"><p class="font-medium">${q.question_id}: ${q.question_text}</p><p class="text-xs text-gray-500">Type: ${q.input_type}</p></div>`;});
      h+='</div>';
      if(s.explanations){h+='<h4 class="font-semibold mt-4">Explanations:</h4><ul class="list-disc list-inside text-sm text-gray-600">';
        Object.entries(s.explanations).forEach(([k,v])=>h+=`<li><strong>${k}:</strong> ${v}</li>`);
        h+='</ul>';
      }
      c.innerHTML=h;
    }

    function downloadDataAsCsv(data,fn){
      if(!data||!data.length){logger.warn(`No data to download for ${fn}.`);return;}
      const hdr=Object.keys(data[0]),rep=(k,v)=>v===null?'':v;
      const csv=[hdr.join(','),...data.map(r=>hdr.map(f=>JSON.stringify(r[f],rep)).join(','))].join('\r\n');
      const b=new Blob([csv],{type:'text/csv;charset=utf-8;'}),a=document.createElement('a');
      if(a.download!==undefined){const u=URL.createObjectURL(b);a.href=u;a.download=fn;a.style.visibility='hidden';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);logger.success(`CSV download initiated for ${fn}.`);}
      else{logger.error("CSV download not supported.");alert("CSV download not supported.");}
    }

    function downloadPaperAsPdf(md,fn='research_paper.pdf'){
      if(!md){logger.warn('No paper content.');alert('No paper.');return;}
      try{const {jsPDF}=window.jspdf,doc=new jsPDF();
        let plain=md.replace(/#{1,6}\s/g,'').replace(/\*\*(.*?)\*\*/g,'$1').replace(/\*(.*?)\*/g,'$1').replace(/`(.*?)`/g,'$1').replace(/\[(.*?)\]\(.*?\)/g,'$1').replace(/^\s*[-*+]\s/gm,'• ').replace(/^\s*\d+\.\s/gm,'• ').trim();
        doc.setFontSize(16).text('Generated Research Paper',20,20).setFontSize(11);
        const lines=doc.splitTextToSize(plain,180);let y=30;
        lines.forEach(line=>{if(y>280){doc.addPage();y=20;}doc.text(line,20,y);y+=6;});
        doc.save(fn);logger.success(`PDF download initiated for ${fn}.`);
      }catch(e){logger.error(`PDF error: ${e.message}`);alert(`PDF error: ${e.message}`);}
    }

    async function apiRequest(ep,body){
      logger.api(`[Frontend] POST ${ep}`);
      try{const res=await fetch(ep,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({apiKeys:appState.apiKeys,...body})});
        const j=await res.json(); if(!res.ok)throw new Error(j.error||`Status ${res.status}`);
        logger.success(`[Backend] ${ep} OK`); return j;
      }catch(e){logger.error(`[API Error] ${e.message}`);alert(`Error: ${e.message}`);throw e;}
    }

    document.addEventListener('DOMContentLoaded',()=>{
      document.querySelectorAll('.main-menu-btn').forEach(b=>b.addEventListener('click',()=>showView(b.dataset.target)));
      document.querySelectorAll('.back-to-menu-btn').forEach(b=>b.addEventListener('click',()=>showView('mainMenuView')));

      document.getElementById('saveApiKeys').addEventListener('click',()=>{
        ['qualtricsApiToken','qualtricsDataCenter','awsAccessKeyId','awsSecretAccessKey','mturkSandbox','openaiApiKey','anthropicApiKey']
          .forEach(id=>appState.apiKeys[id]=document.getElementById(id).value);
        if(Object.values(appState.apiKeys).every(v=>v.trim()!=='')){logger.success('API keys saved.');showView('mainMenuView');}
        else{logger.error('Fill all API fields.');alert('Fill all API fields.');}
      });

      // Create & Enhance Survey
      document.getElementById('processSurveyBtn').addEventListener('click',async()=>{
        const txt=document.getElementById('surveyTextInput').value;
        if(!txt.includes('Topic:')||!txt.includes('Questions:')){alert("Survey text must include 'Topic:' and 'Questions:'");return;}
        try{const r=await apiRequest('/api/process-survey',{surveyText:txt});
          appState.enhancedSurvey=r.survey;
          renderSurveySummary(appState.enhancedSurvey,'enhancedSurveySidebar');
          document.getElementById('sidebarTitle').textContent='Enhanced Survey';
          document.getElementById('enhancement-section').classList.remove('hidden');
        }catch{}
      });
      document.getElementById('reviewBtn').addEventListener('click',()=>renderSurveySummary(appState.enhancedSurvey,'enhancedSurveySidebar'));
      document.getElementById('aiEnhanceBtn').addEventListener('click',()=>showModal('aiEnhanceModal'));
      document.getElementById('manualEditBtn').addEventListener('click',()=>{
        document.getElementById('manualJsonEditor').value=JSON.stringify(appState.enhancedSurvey,null,2);
        showModal('manualEditModal');
      });
      document.getElementById('saveSurveyBtn').addEventListener('click',()=>{
        const b=new Blob([JSON.stringify(appState.enhancedSurvey,null,2)],{type:'application/json'}),a=document.createElement('a');
        a.href=URL.createObjectURL(b);a.download='enhanced_survey.json';a.click();URL.revokeObjectURL(a.href);logger.success('Survey saved.');
      });
      document.getElementById('deployBtn').addEventListener('click',()=>showModal('deployModal'));

      // AI Enhance Modal
      document.getElementById('cancelAiEnhance').addEventListener('click',hideModals);
      document.getElementById('submitAiEnhance').addEventListener('click',async()=>{
        const fb=document.getElementById('aiFeedbackText').value;
        try{const r=await apiRequest('/api/enhance-survey',{survey:appState.enhancedSurvey,feedback:fb});
          appState.enhancedSurvey=r.enhancedSurvey;
          renderSurveySummary(appState.enhancedSurvey,'enhancedSurveySidebar');
          hideModals();
        }catch{}
      });

      // Manual Edit Modal
      document.getElementById('cancelManualEdit').addEventListener('click',hideModals);
      document.getElementById('saveManualEdit').addEventListener('click',()=>{
        try{const j=JSON.parse(document.getElementById('manualJsonEditor').value);
          if(!j.revised_survey||!j.revised_survey.questions)throw new Error('Invalid structure');
          appState.enhancedSurvey=j; renderSurveySummary(appState.enhancedSurvey,'enhancedSurveySidebar'); hideModals();
        }catch(e){alert(`JSON 错误: ${e.message}`);}
      });

      // Deploy Modal
      document.getElementById('useMturk').addEventListener('change',e=>document.getElementById('mturkConfig').classList.toggle('hidden',!e.target.checked));
      document.getElementById('cancelDeploy').addEventListener('click',hideModals);
      document.getElementById('confirmDeploy').addEventListener('click',async()=>{
        const cfg={ survey:appState.enhancedSurvey, useMturk:document.getElementById('useMturk').checked,
          mturkConfig:{ Reward:document.getElementById('mturkReward').value, MaxAssignments:parseInt(document.getElementById('mturkMaxAssignments').value)||100 }};
        try{const r=await apiRequest('/api/deploy',cfg);
          alert(`部署成功!\nSurvey Link: ${r.surveyLink}\nSurvey ID: ${r.surveyId}`+(r.hitId?`\nHIT ID: ${r.hitId}`:''));
          hideModals();
        }catch{}
      });

      // Collect Human Data
      document.getElementById('fetchResultsBtn').addEventListener('click',async()=>{
        const sid=document.getElementById('collectSurveyId').value, hid=document.getElementById('collectHitId').value;
        if(!sid){alert('请输入Qualtrics Survey ID');return;}
        try{const r=await apiRequest('/api/collect-data',{surveyId:sid,hitId:hid});
          appState.humanData=r.data;
          const head=document.getElementById('humanDataTableHead'),body=document.getElementById('humanDataTableBody');
          head.innerHTML='';body.innerHTML='';
          if(r.data.length){
            const cols=Object.keys(r.data[0]);
            head.innerHTML=`<tr>${cols.map(c=>`<th class="p-2 border">${c}</th>`).join('')}</tr>`;
            r.data.forEach(row=>body.innerHTML+=`<tr>${cols.map(c=>`<td class="p-2 border">${row[c]||''}</td>`).join('')}</tr>`);
            document.getElementById('humanDataResults').classList.remove('hidden');
            document.getElementById('downloadCsvBtn').classList.remove('hidden');
          } else alert('无数据');
        }catch{}
      });
      document.getElementById('downloadCsvBtn').addEventListener('click',()=>downloadDataAsCsv(appState.humanData,'human_survey_responses.csv'));

      // Collect Simulated Data
      document.getElementById('runSimulationBtn').addEventListener('click',async()=>{
        document.getElementById('enhancedSidebarWrapper').style.display = 'none';
        document.getElementById('simSidebarWrapper').style.display = 'block';
        document.getElementById('simSidebarTitle').textContent = 'Simulated Responses';
        try{
          const payload={ template:document.getElementById('simTemplate').value,
                          surveyContext:document.getElementById('simSurveyContext').value,
                          participants:document.getElementById('simParticipants').value };
          const r=await apiRequest('/api/simulate-data',payload);
          appState.simulatedData=JSON.parse(r.simulationOutput);
          document.getElementById('simulatedDataResults').classList.remove('hidden');
          document.getElementById('simulatedJsonOutput').textContent=JSON.stringify(appState.simulatedData,null,2);
          document.getElementById('debiasPrompt').classList.remove('hidden');
          document.getElementById('debiasedDataResults').classList.add('hidden');
        }catch{}
      });
      document.getElementById('downloadSimulatedBtn').addEventListener('click',()=>downloadDataAsCsv(appState.simulatedData,'simulated_responses_raw.csv'));

      document.getElementById('runDebiasBtn').addEventListener('click',async()=>{
        try{
          const r=await apiRequest('/api/debias-data',{
            simulatedData:JSON.stringify(appState.simulatedData),
            surveyContext:document.getElementById('simSurveyContext').value
          });
          appState.debiasedData=JSON.parse(r.debiasedOutput);
          document.getElementById('debiasPrompt').classList.add('hidden');
          document.getElementById('debiasedDataResults').classList.remove('hidden');
          document.getElementById('debiasedJsonOutput').textContent=JSON.stringify(appState.debiasedData,null,2);
        }catch{ document.getElementById('debiasPrompt').classList.remove('hidden'); }
      });
      document.getElementById('skipDebiasBtn').addEventListener('click',()=>document.getElementById('debiasPrompt').classList.add('hidden'));
      document.getElementById('downloadDebiasedBtn').addEventListener('click',()=>downloadDataAsCsv(appState.debiasedData,'simulated_responses_debiased.csv'));

      // Generate Paper
      document.getElementById('generatePaperBtn').addEventListener('click',async()=>{
        try{
          const r=await apiRequest('/api/generate-paper',{
            csvData:document.getElementById('paperCsvData').value,
            hypothesis:document.getElementById('paperHypothesis').value
          });
          appState.generatedPaper=r.paperMarkdown;
          document.getElementById('paperMarkdownOutput').innerHTML=r.paperMarkdown.replace(/\n/g,'<br>');
          document.getElementById('paperOutput').classList.remove('hidden');
        }catch{}
      });
      document.getElementById('downloadPdfBtn').addEventListener('click',()=>{
        if(!appState.generatedPaper){alert('请先生成论文');return;}
        downloadPaperAsPdf(appState.generatedPaper,`research_paper_${new Date().toISOString().slice(0,10)}.pdf`);
      });
    });
  </script>
</body>
</html>
